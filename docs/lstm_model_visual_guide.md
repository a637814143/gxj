# LSTM预测模型可视化指南

## 1. 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端 (Vue.js)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 预测中心页面  │  │ 模型管理页面  │  │ 历史记录页面  │          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
└─────────┼──────────────────┼──────────────────┼─────────────────┘
          │                  │                  │
          │ HTTP POST        │ HTTP GET/POST    │ HTTP GET
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                    后端 (Spring Boot)                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    Controller 层                          │  │
│  │  ForecastExecutionController | ForecastModelController   │  │
│  └────────────────────┬─────────────────────────────────────┘  │
│                       │                                          │
│  ┌────────────────────▼─────────────────────────────────────┐  │
│  │                    Service 层                             │  │
│  │  ForecastExecutionService | ForecastModelService         │  │
│  └────────────────────┬─────────────────────────────────────┘  │
│                       │                                          │
│  ┌────────────────────▼─────────────────────────────────────┐  │
│  │                    Engine 层 (核心算法)                   │  │
│  │  ┌──────────────────────────────────────────────────┐    │  │
│  │  │         LocalForecastEngine (主引擎)             │    │  │
│  │  │  ┌────────────┐  ┌────────────┐  ┌────────────┐ │    │  │
│  │  │  │   LSTM     │  │ 天气回归    │  │ 双指数平滑  │ │    │  │
│  │  │  └─────┬──────┘  └────────────┘  └────────────┘ │    │  │
│  │  │        │                                          │    │  │
│  │  │  ┌─────▼──────────────────────────────────────┐  │    │  │
│  │  │  │      Dl4jLstmForecaster (LSTM实现)         │  │    │  │
│  │  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  │  │    │  │
│  │  │  │  │ 数据预处理 │→│ 模型训练  │→│ 递归预测  │  │  │    │  │
│  │  │  │  └──────────┘  └──────────┘  └──────────┘  │  │    │  │
│  │  │  └─────────────────────────────────────────────┘  │    │  │
│  │  └──────────────────────────────────────────────────┘    │  │
│  └────────────────────┬─────────────────────────────────────┘  │
│                       │                                          │
│  ┌────────────────────▼─────────────────────────────────────┐  │
│  │                 Repository 层                             │  │
│  │  ForecastRunRepository | ForecastResultRepository        │  │
│  └────────────────────┬─────────────────────────────────────┘  │
└───────────────────────┼──────────────────────────────────────────┘
                        │
                        ▼
              ┌──────────────────┐
              │   MySQL 数据库    │
              └──────────────────┘
```

---

## 2. LSTM网络结构图

```
输入数据流:
[历史产量序列] → [归一化] → [滑动窗口] → [LSTM网络] → [反归一化] → [预测结果]

详细网络结构:

输入层                LSTM层              输出层
  │                    │                   │
  │  [窗口数据]        │  [32个LSTM单元]   │  [预测值]
  │  维度: [1]         │  维度: [32]       │  维度: [1]
  │                    │                   │
  ▼                    ▼                   ▼
┌─────┐            ┌─────┐             ┌─────┐
│  x  │───────────▶│LSTM │────────────▶│  y  │
│     │            │     │             │     │
│ [1] │            │[32] │             │ [1] │
└─────┘            └─────┘             └─────┘
                      │
                      │ 内部结构:
                      │
        ┌─────────────┴─────────────┐
        │                           │
        │  ┌─────────────────────┐  │
        │  │   遗忘门 (Forget)   │  │
        │  │   ft = σ(Wf·[h,x])  │  │
        │  └─────────────────────┘  │
        │            ↓               │
        │  ┌─────────────────────┐  │
        │  │   输入门 (Input)    │  │
        │  │   it = σ(Wi·[h,x])  │  │
        │  └─────────────────────┘  │
        │            ↓               │
        │  ┌─────────────────────┐  │
        │  │   记忆单元 (Cell)   │  │
        │  │   Ct = ft⊙Ct-1+...  │  │
        │  └─────────────────────┘  │
        │            ↓               │
        │  ┌─────────────────────┐  │
        │  │   输出门 (Output)   │  │
        │  │   ot = σ(Wo·[h,x])  │  │
        │  └─────────────────────┘  │
        │                           │
        └───────────────────────────┘

激活函数:
- LSTM层: TANH (双曲正切)
- 输出层: IDENTITY (线性)

优化器: Adam
损失函数: MSE (均方误差)
```

---

## 3. 滑动窗口示例

```
假设有8年的历史产量数据，窗口大小=3

原始数据:
年份:  2016  2017  2018  2019  2020  2021  2022  2023
产量:  100   120   110   130   140   135   150   145

归一化后 (min=100, max=150):
年份:  2016  2017  2018  2019  2020  2021  2022  2023
归一:  0.0   0.4   0.2   0.6   0.8   0.7   1.0   0.9

滑动窗口训练样本:

样本1: [0.0, 0.4, 0.2] → 0.6
       ├─────────────┤    └─ 目标
       └─ 输入窗口

样本2: [0.4, 0.2, 0.6] → 0.8
       ├─────────────┤    └─ 目标
       └─ 输入窗口

样本3: [0.2, 0.6, 0.8] → 0.7
       ├─────────────┤    └─ 目标
       └─ 输入窗口

样本4: [0.6, 0.8, 0.7] → 1.0
       ├─────────────┤    └─ 目标
       └─ 输入窗口

样本5: [0.8, 0.7, 1.0] → 0.9
       ├─────────────┤    └─ 目标
       └─ 输入窗口

总共5个训练样本
```

---

## 4. 递归预测过程

```
预测未来3年 (2024, 2025, 2026)

初始状态:
历史序列: [0.0, 0.4, 0.2, 0.6, 0.8, 0.7, 1.0, 0.9]
                                          └────┬────┘
                                          最后3个值

步骤1: 预测2024年
┌──────────────────────────────────────┐
│ 输入窗口: [0.7, 1.0, 0.9]            │
│           └─────────────┘             │
│              ↓                        │
│         [LSTM网络]                    │
│              ↓                        │
│ 预测值: 0.85 (归一化)                │
│ 反归一化: 0.85 × 50 + 100 = 142.5   │
└──────────────────────────────────────┘

更新序列: [0.0, 0.4, 0.2, 0.6, 0.8, 0.7, 1.0, 0.9, 0.85]

步骤2: 预测2025年
┌──────────────────────────────────────┐
│ 输入窗口: [1.0, 0.9, 0.85]           │
│           └──────────────┘            │
│              ↓                        │
│         [LSTM网络]                    │
│              ↓                        │
│ 预测值: 0.82 (归一化)                │
│ 反归一化: 0.82 × 50 + 100 = 141.0   │
└──────────────────────────────────────┘

更新序列: [..., 0.9, 0.85, 0.82]

步骤3: 预测2026年
┌──────────────────────────────────────┐
│ 输入窗口: [0.9, 0.85, 0.82]          │
│           └───────────────┘           │
│              ↓                        │
│         [LSTM网络]                    │
│              ↓                        │
│ 预测值: 0.80 (归一化)                │
│ 反归一化: 0.80 × 50 + 100 = 140.0   │
└──────────────────────────────────────┘

最终结果:
2024年: 142.5
2025年: 141.0
2026年: 140.0
```

---

## 5. 训练过程可视化

```
Epoch 1:
Loss: 0.0523 ████████████████████████████████████████ 100%

Epoch 2:
Loss: 0.0412 ████████████████████████████████████░░░░  95%

Epoch 3:
Loss: 0.0356 ████████████████████████████████░░░░░░░░  85%

...

Epoch 50:
Loss: 0.0089 ████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░  25%

Epoch 100:
Loss: 0.0023 ███░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░   5%

训练完成！

损失函数下降曲线:
Loss
 │
0.05│●
    │ ●
0.04│  ●
    │   ●●
0.03│     ●●
    │       ●●●
0.02│          ●●●●
    │              ●●●●●
0.01│                   ●●●●●●●
    │                         ●●●●●●●●●●●
0.00└─────────────────────────────────────▶ Epoch
    0    20    40    60    80   100
```

---

## 6. 参数影响示例

### 6.1 学习率影响

```
learningRate = 0.001 (太小)
Loss下降慢，需要更多epochs
Loss
 │
0.05│●
    │ ●
0.04│  ●
    │   ●
0.03│    ●
    │     ●
0.02│      ●
    │       ●
0.01│        ●
    │         ●
0.00└──────────────▶ Epoch
    0   50  100

learningRate = 0.01 (合适)
Loss下降平稳
Loss
 │
0.05│●
    │ ●●
0.04│   ●●
    │     ●●
0.03│       ●●
    │         ●●
0.02│           ●●
    │             ●●
0.01│               ●●●
    │                  ●●●●●
0.00└──────────────▶ Epoch
    0   50  100

learningRate = 0.1 (太大)
Loss震荡，难以收敛
Loss
 │
0.05│● ●   ●
    │  ● ●  ●
0.04│   ●    ●
    │ ●   ●   ●
0.03│  ●   ●   ●
    │●  ●   ●   ●
0.02│ ●  ●   ●
    │  ●  ●   ●
0.01│   ●  ●   ●
    │    ●  ●   ●
0.00└──────────────▶ Epoch
    0   50  100
```

### 6.2 Epochs影响

```
epochs = 20 (太少)
模型欠拟合，预测不准确
预测误差: RMSE = 15.2

epochs = 100 (合适)
模型收敛良好
预测误差: RMSE = 5.8

epochs = 500 (太多)
模型过拟合，泛化能力差
预测误差: RMSE = 8.3
```

---

## 7. 算法选择流程图

```
开始预测
    │
    ▼
┌─────────────────┐
│ 检查模型类型     │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
WEATHER_   LSTM?
REGRESSION?
    │         │
    │ Yes     │ Yes
    ▼         ▼
┌─────────┐ ┌─────────┐
│天气回归 │ │强制LSTM │
│预测     │ │预测     │
└────┬────┘ └────┬────┘
     │           │
     │           │
     └─────┬─────┘
           │
           ▼
    ┌──────────────┐
    │ 返回预测结果  │
    └──────────────┘
           │
           ▼
         结束

    │ No (其他类型)
    ▼
┌─────────────────────────┐
│ 运行多个算法并比较       │
├─────────────────────────┤
│ 1. DOUBLE_EXPONENTIAL   │
│    RMSE = 12.5          │
├─────────────────────────┤
│ 2. LINEAR_TREND         │
│    RMSE = 15.3          │
├─────────────────────────┤
│ 3. LSTM                 │
│    RMSE = 8.7           │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 选择RMSE最低的算法      │
│ → LSTM (8.7)            │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 返回最佳算法的预测结果   │
└─────────────────────────┘
```

---

## 8. 数据库实体关系图

```
┌──────────────────┐
│  ForecastModel   │ 预测模型
├──────────────────┤
│ id               │
│ name             │ "小麦LSTM模型"
│ type             │ LSTM / WEATHER_REGRESSION
│ description      │
│ parameters       │ JSON
└────────┬─────────┘
         │ 1
         │
         │ N
         ▼
┌──────────────────┐
│  ForecastTask    │ 预测任务
├──────────────────┤
│ id               │
│ model_id         │ ──┐
│ crop_id          │   │
│ region_id        │   │
│ status           │   │
│ parameters       │   │
└────────┬─────────┘   │
         │ 1           │
         │             │
         │ N           │
         ▼             │
┌──────────────────┐   │
│  ForecastRun     │ 预测运行记录
├──────────────────┤   │
│ id               │   │
│ model_id         │ ──┘
│ crop_id          │
│ region_id        │
│ status           │ RUNNING / SUCCESS / FAILED
│ mae              │ 5.23
│ rmse             │ 8.76
│ mape             │ 4.12
│ r2               │ 0.89
└────────┬─────────┘
         │ 1
         │
    ┌────┴────┬────────────┐
    │         │            │
    │ N       │ N          │ N
    ▼         ▼            ▼
┌─────────┐ ┌──────────┐ ┌──────────┐
│Forecast │ │Forecast  │ │Forecast  │
│RunSeries│ │Snapshot  │ │Result    │
├─────────┤ ├──────────┤ ├──────────┤
│run_id   │ │run_id    │ │task_id   │
│period   │ │period    │ │target_yr │
│value    │ │year      │ │predicted │
│lower    │ │predicted │ │evaluation│
│upper    │ │measurement│ └──────────┘
│historical│ └──────────┘
└─────────┘
时间序列   预测快照      最终结果
(图表展示) (中间数据)   (业务使用)
```

---

## 9. 完整预测示例

```
场景: 预测河北省小麦2024-2026年产量

输入数据:
┌──────┬──────────┐
│ 年份 │ 产量(万吨)│
├──────┼──────────┤
│ 2016 │   100    │
│ 2017 │   120    │
│ 2018 │   110    │
│ 2019 │   130    │
│ 2020 │   140    │
│ 2021 │   135    │
│ 2022 │   150    │
│ 2023 │   145    │
└──────┴──────────┘

参数配置:
{
  "learningRate": 0.01,
  "seed": 42,
  "epochs": 100
}

处理流程:

1. 数据归一化
   min = 100, max = 150, range = 50
   归一化: [0.0, 0.4, 0.2, 0.6, 0.8, 0.7, 1.0, 0.9]

2. 计算窗口大小
   windowSize = min(12, max(2, 8/2)) = 4

3. 构建训练集
   样本数 = 8 - 4 = 4个样本

4. 训练LSTM
   Epochs: 100
   最终Loss: 0.0023

5. 递归预测
   2024: 0.85 → 142.5万吨
   2025: 0.82 → 141.0万吨
   2026: 0.80 → 140.0万吨

6. 计算置信区间
   confidenceBand = 5.2
   2024: [137.3, 147.7]
   2025: [135.8, 146.2]
   2026: [134.8, 145.2]

输出结果:
┌──────┬──────────┬──────────┬──────────┐
│ 年份 │ 预测产量  │ 下界     │ 上界     │
├──────┼──────────┼──────────┼──────────┤
│ 2024 │  142.5   │  137.3   │  147.7   │
│ 2025 │  141.0   │  135.8   │  146.2   │
│ 2026 │  140.0   │  134.8   │  145.2   │
└──────┴──────────┴──────────┴──────────┘

评估指标:
MAE:  5.23
RMSE: 8.76
MAPE: 4.12%
R²:   0.89
```

---

## 10. 常见问题

### Q1: 为什么预测结果不变？
```
问题: 修改参数后预测结果相同

原因分析:
┌─────────────────────────────────┐
│ 模型类型不是LSTM                 │
│         ↓                        │
│ 系统运行多算法比较                │
│         ↓                        │
│ 选择了其他算法(如双指数平滑)      │
│         ↓                        │
│ LSTM参数不生效                   │
└─────────────────────────────────┘

解决方案:
1. 确保模型type字段为"LSTM"
2. 重启后端服务
3. 使用不同参数测试
```

### Q2: 预测精度如何提高？
```
方法1: 增加历史数据
  5年数据 → 10年数据
  RMSE: 12.5 → 8.7

方法2: 调整学习率
  learningRate: 0.01 → 0.005
  更慢但更稳定的收敛

方法3: 增加训练轮数
  epochs: 100 → 200
  更充分的训练

方法4: 使用天气特征
  LSTM → WEATHER_REGRESSION
  结合气象数据提高精度
```

### Q3: 如何选择合适的参数？
```
learningRate:
├─ 0.001-0.005: 数据量少、噪声大
├─ 0.01:        默认值，适合大多数情况
└─ 0.05-0.1:    数据量大、趋势明显

epochs:
├─ 50-100:      小数据集(< 10个样本)
├─ 100-200:     中等数据集(10-20个样本)
└─ 自动计算:     让系统根据样本数决定

seed:
├─ 固定值(如42): 需要结果可复现
└─ 随机值:       探索不同初始化的效果
```

---

这份可视化指南提供了更直观的理解方式，配合前面的详细技术文档，应该能够全面理解你的LSTM预测系统！
