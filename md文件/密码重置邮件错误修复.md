# 密码重置邮件错误修复

## 问题描述
管理员重置其他用户密码时出现错误：
```
No bean named 'mailTaskExecutor' available: 
No matching Executor bean found for qualifier 'mailTaskExecutor' 
- neither qualifier match nor bean name match!
```

## 问题原因
`EmailSender.java`中使用了`@Async("mailTaskExecutor")`注解来异步发送邮件，但是`AsyncConfig.java`中没有定义这个Bean。

## 代码位置

### 使用位置
**文件**：`demo/src/main/java/com/gxj/cropyield/common/mail/EmailSender.java`
```java
@Async("mailTaskExecutor")
public CompletableFuture<Void> sendHtmlAsync(String to, String subject, String htmlContent) {
    // 异步发送邮件
}
```

### 缺失位置
**文件**：`demo/src/main/java/com/gxj/cropyield/config/AsyncConfig.java`
- 原来只定义了：`taskExecutor`、`forecastExecutor`、`importExecutor`
- 缺少：`mailTaskExecutor`

## 解决方案

在`AsyncConfig.java`中添加`mailTaskExecutor` Bean：

```java
/**
 * 配置邮件发送专用执行器
 * 
 * 用于异步发送邮件（密码重置、通知等）
 */
@Bean(name = "mailTaskExecutor")
public Executor getMailTaskExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    
    // 邮件发送通常很快，使用较小的线程池
    executor.setCorePoolSize(2);
    executor.setMaxPoolSize(5);
    executor.setQueueCapacity(100);
    executor.setThreadNamePrefix("mail-task-");
    executor.setKeepAliveSeconds(60);
    executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
    executor.setWaitForTasksToCompleteOnShutdown(true);
    executor.setAwaitTerminationSeconds(30);
    
    executor.initialize();
    
    log.info("邮件任务执行器初始化完成 - 核心线程: {}, 最大线程: {}, 队列容量: {}", 
            executor.getCorePoolSize(), executor.getMaxPoolSize(), executor.getQueueCapacity());
    
    return executor;
}
```

## 配置说明

### 线程池参数
- **核心线程数**：2（邮件发送不频繁）
- **最大线程数**：5（高峰期最多5个并发）
- **队列容量**：100（可以排队100封邮件）
- **线程名前缀**：`mail-task-`（便于日志追踪）
- **空闲时间**：60秒
- **拒绝策略**：CallerRunsPolicy（队列满时由调用线程执行）

### 为什么需要单独的邮件执行器？
1. **隔离性**：邮件发送失败不影响其他异步任务
2. **可控性**：可以单独控制邮件发送的并发数
3. **监控性**：可以单独监控邮件发送的性能

## 测试步骤

1. 重启后端服务
2. 使用管理员账号登录
3. 进入用户管理页面
4. 选择一个用户，点击"重置密码"
5. 确认操作成功，用户收到密码重置邮件

## 相关功能

使用`mailTaskExecutor`的功能：
- ✅ 密码重置邮件
- ✅ 注册验证邮件
- ✅ 系统通知邮件

---

**修复时间**：2026-01-06  
**状态**：✅ 已修复
