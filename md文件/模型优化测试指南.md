# 模型优化测试指南

## 测试目的
验证ARIMA、Prophet、LSTM三个模型的R²优化效果

## 测试步骤

### 1. 重启后端服务
```bash
cd demo
./mvnw spring-boot:run
```

### 2. 准备测试数据
使用小麦产量数据（15年历史数据）：
- 作物：小麦
- 地区：任意
- 年份：2010-2024
- 预测期数：3年

### 3. 测试各个模型

#### 测试LSTM模型
1. 选择模型：DeepLearning4j LSTM 产量模型 (LSTM)
2. 配置参数：
   - 作物：小麦
   - 预测步数：3
   - 时间粒度：年度
3. 点击"生成预测"
4. 查看结果中的R²值

**预期结果**：
- R² > 0.3：优化成功
- R² = -1.00：仍有问题

#### 测试ARIMA模型
1. 选择模型：ARIMA 季节性时序模型 (ARIMA)
2. 配置参数：
   - 作物：小麦
   - 预测步数：3
   - 时间粒度：年度
3. 点击"生成预测"
4. 查看结果中的R²值

**预期结果**：
- R² > 0.2：优化成功
- R² = -1.00：仍有问题

#### 测试Prophet模型
1. 选择模型：Prophet 事件影响模型 (PROPHET)
2. 配置参数：
   - 作物：小麦
   - 预测步数：3
   - 时间粒度：年度
3. 点击"生成预测"
4. 查看结果中的R²值

**预期结果**：
- R² > 0.2：优化成功
- R² = -1.00：仍有问题

### 4. 对比测试

创建多个预测任务，对比不同模型的表现：

| 模型 | 优化前R² | 优化后R²（预期） | MAE | RMSE | MAPE |
|-----|---------|----------------|-----|------|------|
| LSTM | -1.00 | > 0.3 | 待测 | 待测 | 待测 |
| ARIMA | -1.00 | > 0.2 | 待测 | 待测 | 待测 |
| Prophet | -1.00 | > 0.2 | 待测 | 待测 | 待测 |
| 天气回归 | 正常 | 保持 | 待测 | 待测 | 待测 |

## 问题排查

### 如果R²仍然是-1.00

#### 1. 检查数据质量
```sql
-- 查看历史数据
SELECT year, yield_value 
FROM yield_record 
WHERE crop_id = ? AND region_id = ?
ORDER BY year;

-- 检查数据是否有异常值
SELECT 
    MIN(yield_value) as min_yield,
    MAX(yield_value) as max_yield,
    AVG(yield_value) as avg_yield,
    STDDEV(yield_value) as stddev_yield
FROM yield_record 
WHERE crop_id = ? AND region_id = ?;
```

#### 2. 检查后端日志
查看是否有异常信息：
```bash
tail -f demo/logs/application.log
```

关注以下关键词：
- `ArimaForecaster`
- `ProphetForecaster`
- `Dl4jLstmForecaster`
- `Exception`
- `Error`

#### 3. 检查预测值
在数据库中查看预测结果：
```sql
SELECT 
    fr.id,
    fr.model_type,
    fr.r2,
    fr.mae,
    fr.rmse,
    fr.mape,
    fs.year,
    fs.predicted_value
FROM forecast_run fr
LEFT JOIN forecast_snapshot fs ON fr.id = fs.run_id
WHERE fr.created_at > NOW() - INTERVAL 1 HOUR
ORDER BY fr.created_at DESC, fs.year;
```

检查：
- `predicted_value` 是否为负数
- `predicted_value` 是否为NaN或Infinity
- `predicted_value` 是否与历史数据差距过大

### 常见问题

#### 问题1：预测值全部相同
**原因**：模型退化为常数预测
**解决**：增加训练数据或调整模型参数

#### 问题2：预测值为负数
**原因**：后处理逻辑未生效
**解决**：检查代码是否正确编译和部署

#### 问题3：预测值跳变很大
**原因**：平滑处理未生效
**解决**：检查标准差计算是否正确

#### 问题4：R²仍然是-1.00
**原因**：预测误差仍然很大
**解决**：
1. 检查数据是否有明显趋势
2. 尝试不同的模型参数
3. 增加历史数据量

## 性能测试

### 测试预测速度
记录每个模型的执行时间：

| 模型 | 数据量 | 执行时间（秒） | 是否超时 |
|-----|-------|--------------|---------|
| LSTM | 15个点 | 待测 | 否 |
| ARIMA | 15个点 | 待测 | 否 |
| Prophet | 15个点 | 待测 | 否 |

**预期**：
- LSTM：< 30秒
- ARIMA：< 5秒
- Prophet：< 5秒

## 成功标准

### 最低标准（必须达到）
- ✅ 所有模型R² > -0.5
- ✅ 预测值不为负数
- ✅ 预测值不为NaN或Infinity
- ✅ 预测不超时

### 理想标准（期望达到）
- ✅ LSTM R² > 0.3
- ✅ ARIMA R² > 0.2
- ✅ Prophet R² > 0.2
- ✅ 预测值变化平滑
- ✅ 执行时间合理

### 优秀标准（最佳情况）
- ✅ LSTM R² > 0.5
- ✅ ARIMA R² > 0.4
- ✅ Prophet R² > 0.4
- ✅ MAE < 数据标准差的50%
- ✅ MAPE < 10%

## 测试报告模板

```
测试时间：2026-01-06
测试人员：[姓名]
测试环境：[开发/测试/生产]

### 测试结果

#### LSTM模型
- R²：[值]
- MAE：[值]
- RMSE：[值]
- MAPE：[值]%
- 执行时间：[秒]
- 状态：[通过/失败]

#### ARIMA模型
- R²：[值]
- MAE：[值]
- RMSE：[值]
- MAPE：[值]%
- 执行时间：[秒]
- 状态：[通过/失败]

#### Prophet模型
- R²：[值]
- MAE：[值]
- RMSE：[值]
- MAPE：[值]%
- 执行时间：[秒]
- 状态：[通过/失败]

### 问题记录
[记录遇到的问题]

### 改进建议
[记录改进建议]
```

---

**创建时间**：2026-01-06  
**用途**：验证模型优化效果
